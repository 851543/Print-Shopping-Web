<!DOCTYPE html>
<html>
<head>
	<!-- 首页 -->
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="format-detection" content="telephone=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="author" content="">
	<meta name="keywords" content="">
	<meta name="description" content="">
	<!-- 标题 -->
	<title>PRINT科技商城</title>
	<!-- google字体 -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet">
	<!-- bootstrap的样式 -->
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<!-- 我的样式 -->
	<link rel="stylesheet" type="text/css" href="css/vendor.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<!-- 引入 Bootstrap Icons CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

</head>
<section class="order-payment padding-large">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <!-- 订单状态 -->
        <div class="text-center mb-4">
          <div class="status-icon mb-3">
            <svg class="text-warning" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <h2>等待支付</h2>
          <p class="text-muted">请在 <span class="text-danger" id="countdown">14:59</span> 内完成支付</p>
        </div>

        <!-- 订单信息 -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-3">
              <span>订单号</span>
              <span class="text-muted">2024031912345678</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>应付金额</span>
              <span class="text-primary h4 mb-0">¥90499.00</span>
            </div>
          </div>
        </div>

        <!-- 支付宝支付按钮 -->
        <div class="text-center">
          <button id="aliPayBtn" class="btn btn-primary btn-lg px-5">
            <i class="bi bi-credit-card me-2" style="font-size: 24px;"></i>
            支付宝支付
          </button>
        </div>

        <!-- 订单详情折叠面板 -->
        <div class="accordion mt-4" id="orderDetails">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetails">
                查看订单详情
              </button>
            </h2>
            <div id="collapseDetails" class="accordion-collapse collapse" data-bs-parent="#orderDetails">
              <div class="accordion-body">
                <!-- 商品清单 -->
                <div class="mb-4">
                  <h5 class="mb-3">商品清单</h5>
                  <div class="d-flex mb-3 pb-3 border-bottom">
                    <img src="images/cart-item1.jpg" alt="智能机器人" style="width: 60px; height: 60px; object-fit: cover;">
                    <div class="ms-3">
                      <h6 class="mb-1">智能机器人</h6>
                      <p class="text-muted mb-0">¥8500.00 × 1</p>
                    </div>
                  </div>
                  <div class="d-flex">
                    <img src="images/cart-item2.jpg" alt="���能相机" style="width: 60px; height: 60px; object-fit: cover;">
                    <div class="ms-3">
                      <h6 class="mb-1">智能相机</h6>
                      <p class="text-muted mb-0">¥5999.00 × 1</p>
                    </div>
                  </div>
                </div>
                <!-- 收货信息 -->
                <div>
                  <h5 class="mb-3">收货信息</h5>
                  <p class="mb-1"><strong>收货人：</strong>张三</p>
                  <p class="mb-1"><strong>联系电话：</strong>138****5678</p>
                  <p class="mb-0"><strong>收货地址：</strong>广东省深圳市南山区科技园路1号 A栋501室</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 引入支付宝 JS SDK -->
<script src="https://gw.alipayobjects.com/as/g/h5-lib/alipayjsapi/3.1.1/alipayjsapi.min.js"></script>

<script>
// 订单信息
const orderInfo = {
    outTradeNo: '2024031912345678', // 商户订单号
    totalAmount: '13999.00',         // 订单金额
    subject: 'PRINT科技商城订单',     // 订单标题
    body: '智能机器人×1,智能相机×1'   // 订单描述
};

// 支付宝支付配置
const alipayConfig = {
    // 这些参数需要从后端获取，这里仅作示例
    appId: '2021000122123456',             // 支付宝沙箱 APPID
    gateway: 'https://openapi.alipaydev.com/gateway.do', // 支付宝沙箱网关
    returnUrl: 'http://你的域名/order-success.html',     // 支付成功后跳转页面
    notifyUrl: 'http://你的域名/api/notify'              // 支付结果通知地址
};

// 初始化支付按钮点击事件
document.getElementById('aliPayBtn').addEventListener('click', function() {
    initAlipay();
});

// 初始化支付宝支付
async function initAlipay() {
    try {
        // 构建支付请求参数
        const payParams = {
            method: 'alipay.trade.page.pay',          // 统一收单下单并支付页面接口
            app_id: alipayConfig.appId,               // APPID
            timestamp: new Date().toISOString(),      // 发送请求时间
            version: '1.0',                           // 接口版本
            biz_content: JSON.stringify({
                out_trade_no: orderInfo.outTradeNo,   // 商户订单号
                product_code: 'FAST_INSTANT_TRADE_PAY',// 产品码
                total_amount: orderInfo.totalAmount,   // 订单金额
                subject: orderInfo.subject,            // 订单标题
                body: orderInfo.body                   // 订单描述
            }),
            return_url: alipayConfig.returnUrl,       // 同步返回地址
            notify_url: alipayConfig.notifyUrl        // 异步通知地址
        };

        // 创建临时表单提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = alipayConfig.gateway;
        form.target = '_blank';

        // 添加参数到表单
        for (let key in payParams) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = payParams[key];
            form.appendChild(input);
        }

        // 提交表单
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        // 开始轮询订单状态
        startCheckOrderStatus(orderInfo.outTradeNo);

    } catch (error) {
        console.error('支付初始化失败:', error);
        alert('支付初始化失败，请稍后重试');
    }
}

// 轮询检查订单状态
function startCheckOrderStatus(orderNo) {
    const checkInterval = setInterval(async () => {
        try {
            // 这里应该调用你的后端 API 检查订单状态
            const response = await fetch(`/api/check-order-status?orderNo=${orderNo}`);
            const result = await response.json();
            
            if (result.status === 'TRADE_SUCCESS') {
                // 支付成功
                clearInterval(checkInterval);
                window.location.href = 'order-success.html';
            } else if (result.status === 'TRADE_CLOSED') {
                // 订单关闭
                clearInterval(checkInterval);
                alert('支付已取消');
            }
        } catch (error) {
            console.error('检查订单状态失败:', error);
        }
    }, 3000); // 每3秒检查一次

    // 15分钟后停止轮询
    setTimeout(() => {
        clearInterval(checkInterval);
    }, 15 * 60 * 1000);
}

// 倒计时代码保持不变
function startCountdown() {
  let minutes = 14;
  let seconds = 59;
  
  const countdownEl = document.getElementById('countdown');
  const interval = setInterval(() => {
    if (seconds === 0) {
      if (minutes === 0) {
        clearInterval(interval);
        window.location.href = 'order-expired.html';
        return;
      }
      minutes--;
      seconds = 59;
    } else {
      seconds--;
    }
    
    countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

document.addEventListener('DOMContentLoaded', startCountdown);
</script> 